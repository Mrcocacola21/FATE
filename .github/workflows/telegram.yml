name: Telegram Notify

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: diff
        run: |
          BEFORE=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          AFTER=$(git rev-parse HEAD)

          if [ -z "$BEFORE" ]; then
            FILES=$(git show --pretty="" --name-only $AFTER | sed 's/^/‚Ä¢ /')
          else
            FILES=$(git diff --name-only $BEFORE $AFTER | sed 's/^/‚Ä¢ /')
          fi

          COUNT=$(echo "$FILES" | grep -c "‚Ä¢" || true)

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "after=$AFTER" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          MESSAGE="#${{ github.event.repository.name }} | UPDATE%0A%0A"
          MESSAGE="${MESSAGE}Files changed: ${{ steps.diff.outputs.count }}%0A"
          MESSAGE="${MESSAGE}${{ steps.diff.outputs.files }}%0A%0A"
          MESSAGE="${MESSAGE}üîç VIEW CHANGES%0A"
          MESSAGE="${MESSAGE}https://github.com/${{ github.repository }}/commit/${{ steps.diff.outputs.after }}"

          curl -s "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d disable_web_page_preview=true
